.package-and-qa-base:
  extends: .default-only
  image: ruby:2.6-alpine
  stage: qa
  needs: ["build-qa-image", "gitlab:assets:compile pull-cache"]
  dependencies: []
  variables:
    GIT_DEPTH: "1"
  retry: 0
  script:
    - source scripts/utils.sh
    - install_gitlab_gem
    - ./scripts/trigger-build omnibus

package-and-qa-manual:
  extends:
    - .package-and-qa-base
    - .only-code-changes
  when: manual

package-and-qa:
  extends:
    - .package-and-qa-base
  only:
    variables:
      - $CI_PROJECT_PATH == "gitlab-org/gitlab-ce"
      - $CI_PROJECT_PATH == "gitlab-org/gitlab-ee"
    changes:
      - qa/*
  except:
    refs:
      - master
  allow_failure: true
